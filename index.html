<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Job Tracker Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        app: {
                            bg: '#050b14',
                            card: '#0f172a',
                            lighter: '#1e293b',
                            primary: '#3b82f6',
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444',
                            text: '#f8fafc',
                            muted: '#94a3b8',
                            border: '#1e293b'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050b14; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #050b14; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 2px; }
        .fab-shadow { box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.5); }
        .nav-item.active { color: #3b82f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Toast Animation */
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .toast { animation: slideUp 0.3s ease-out forwards; }

        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 30px #0f172a inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- MAIN CONTENT AREA -->
    <main id="app-content" class="flex-1 overflow-y-auto pb-24 relative">
        <!-- Views injected here -->
    </main>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[60] flex flex-col gap-2 pointer-events-none w-full max-w-sm px-4"></div>

    <!-- FLOATING ACTION BUTTON -->
    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
        <button onclick="toggleFabMenu()" class="w-14 h-14 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl fab-shadow transition-transform active:scale-95">
            <i class="fa-solid fa-plus transition-transform duration-300" id="fab-icon"></i>
        </button>
    </div>

    <!-- FAB MENU -->
    <div id="fab-menu" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-40 hidden flex-col gap-3 items-center">
        <button onclick="router.navigate('new-job'); toggleFabMenu()" class="bg-app-card border border-app-border text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 w-48 hover:bg-app-lighter transition-colors">
            <div class="w-8 h-8 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-briefcase"></i></div>
            New Job
        </button>
        <button onclick="router.navigate('new-contact'); toggleFabMenu()" class="bg-app-card border border-app-border text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 w-48 hover:bg-app-lighter transition-colors">
            <div class="w-8 h-8 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center"><i class="fa-solid fa-user-plus"></i></div>
            New Contact
        </button>
    </div>
    
    <!-- OVERLAY -->
    <div id="fab-overlay" onclick="toggleFabMenu()" class="fixed inset-0 bg-black/60 z-30 hidden backdrop-blur-sm"></div>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 w-full bg-app-card border-t border-app-border h-[80px] pb-4 px-6 flex justify-between items-center z-20">
        <button onclick="router.navigate('today')" class="nav-item flex flex-col items-center gap-1 text-app-muted text-xs active" data-target="today">
            <i class="fa-solid fa-table-cells-large text-xl mb-0.5"></i> Today
        </button>
        <button onclick="router.navigate('calendar')" class="nav-item flex flex-col items-center gap-1 text-app-muted text-xs" data-target="calendar">
            <i class="fa-regular fa-calendar text-xl mb-0.5"></i> Calendar
        </button>
        <div class="w-12"></div> <!-- Spacer -->
        <button onclick="router.navigate('contacts')" class="nav-item flex flex-col items-center gap-1 text-app-muted text-xs" data-target="contacts">
            <i class="fa-regular fa-user text-xl mb-0.5"></i> Contacts
        </button>
        <button onclick="router.navigate('more')" class="nav-item flex flex-col items-center gap-1 text-app-muted text-xs" data-target="more">
            <i class="fa-solid fa-bars text-xl mb-0.5"></i> More
        </button>
    </nav>

    <!-- HIDDEN FILE INPUT FOR CSV IMPORT -->
    <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleCSVUpload(this)">

    <!-- LOGIC -->
    <script>
        // --- DATA LAYER ---
        const DB = {
            jobs: [],
            contacts: [],
            // Expanded Status Config
            statuses: {
                'Scheduled': { color: 'bg-blue-500', icon: 'fa-calendar' },
                'In Progress': { color: 'bg-orange-500', icon: 'fa-person-digging' },
                'Completed': { color: 'bg-green-500', icon: 'fa-check' },
                'Paid': { color: 'bg-emerald-600', icon: 'fa-dollar-sign' },
                'Cancelled': { color: 'bg-red-500', icon: 'fa-xmark' }
            },
            user: { name: "Richard", email: "richarddyatess@gmail.com" },
            
            init() {
                const savedJobs = localStorage.getItem('app_jobs');
                const savedContacts = localStorage.getItem('app_contacts');
                if (savedJobs) this.jobs = JSON.parse(savedJobs);
                if (savedContacts) this.contacts = JSON.parse(savedContacts);
            },
            
            save() {
                localStorage.setItem('app_jobs', JSON.stringify(this.jobs));
                localStorage.setItem('app_contacts', JSON.stringify(this.contacts));
            },

            addJob(job) {
                this.jobs.push({ ...job, id: Date.now().toString() });
                this.save();
                Utils.toast('Job created successfully');
            },

            updateJob(id, updates) {
                const index = this.jobs.findIndex(j => j.id === id);
                if (index !== -1) {
                    this.jobs[index] = { ...this.jobs[index], ...updates };
                    this.save();
                    return true;
                }
                return false;
            },

            getJob(id) { return this.jobs.find(j => j.id === id); },

            addContact(contact) {
                // Prevent duplicates by name
                if (!this.contacts.some(c => c.name === contact.name)) {
                    this.contacts.push({ ...contact, id: Date.now().toString() + Math.random().toString().slice(2,5) });
                    this.save();
                    return true;
                }
                return false;
            },
            
            getContactByName(name) { return this.contacts.find(c => c.name === name); },

            getJobsForDate(dateStr) { return this.jobs.filter(job => job.date === dateStr); },

            getJobStats() {
                const todayStr = new Date().toISOString().split('T')[0];
                return {
                    today: this.jobs.filter(j => j.date === todayStr).length,
                    active: this.jobs.filter(j => ['Scheduled', 'In Progress'].includes(j.status)).length,
                    completed: this.jobs.filter(j => j.status === 'Completed').length
                };
            }
        };

        // --- UTILS ---
        const Utils = {
            getGreeting: () => {
                const h = new Date().getHours();
                return h < 12 ? "Good morning" : h < 18 ? "Good afternoon" : "Good evening";
            },
            formatDate: (d) => d.toISOString().split('T')[0],
            getFriendlyDate: (str) => new Date(str).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),
            
            toast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const icon = type === 'success' ? 'fa-circle-check text-green-500' : 'fa-circle-info text-blue-500';
                el.className = 'toast bg-app-lighter border border-app-border text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 backdrop-blur-md bg-opacity-90';
                el.innerHTML = `<i class="fa-solid ${icon}"></i> <span class="text-sm font-medium">${msg}</span>`;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            },

            // Basic CSV Parser that handles quoted strings
            parseCSVLine(text) {
                let re_valid = /^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;
                let re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
                if (!re_valid.test(text)) return null;
                let a = [];
                text.replace(re_value, function(m0, m1, m2, m3) {
                    if      (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
                    else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
                    else if (m3 !== undefined) a.push(m3);
                    return ''; 
                });
                if (/,\s*$/.test(text)) a.push('');
                return a;
            }
        };

        // --- ROUTER ---
        const router = {
            currentRoute: 'today',
            navigate(route, params = {}) {
                this.currentRoute = route;
                
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('active', 'text-blue-500');
                    el.classList.add('text-app-muted');
                    if (el.dataset.target === route) {
                        el.classList.add('active', 'text-blue-500');
                        el.classList.remove('text-app-muted');
                    }
                });

                const content = document.getElementById('app-content');
                content.scrollTop = 0; 

                // Routing Logic
                switch(route) {
                    case 'today': this.renderToday(content); break;
                    case 'calendar': this.renderCalendar(content); break;
                    case 'contacts': this.renderContacts(content); break;
                    case 'more': this.renderMore(content); break;
                    case 'new-job': this.renderNewJob(content); break;
                    case 'new-contact': this.renderNewContact(content); break;
                    case 'job-detail': this.renderJobDetail(content, params); break;
                    case 'edit-job-notes': this.renderEditJobNotes(content, params); break;
                }
            },

            // --- VIEW RENDERERS ---

            renderToday(container) {
                const todayStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                const stats = DB.getJobStats();
                const todayIso = new Date().toISOString().split('T')[0];
                const todayJobs = DB.getJobsForDate(todayIso);

                let jobsHtml = todayJobs.length === 0 ? this.components.emptyState('No jobs today', 'Enjoy your free time') : 
                               `<div class="mt-4 space-y-3">${todayJobs.map(job => this.components.jobCard(job)).join('')}</div>`;

                container.innerHTML = `
                    <div class="px-5 pt-12 pb-6">
                        <p class="text-app-muted text-sm mb-1 uppercase tracking-wider font-semibold text-[10px]">${todayStr}</p>
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold text-white">${Utils.getGreeting()}, ${DB.user.name}</h1>
                            <div class="w-10 h-10 rounded-full bg-blue-500/10 text-blue-500 flex items-center justify-center border border-blue-500/20">
                                <i class="fa-solid fa-user"></i>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-3 gap-3 mb-8">
                            ${this.components.statCard('Today', todayJobs.length, 'text-white', 'bg-blue-600')}
                            ${this.components.statCard('Active', stats.active, 'text-orange-400', 'bg-app-card')}
                            ${this.components.statCard('Done', stats.completed, 'text-emerald-400', 'bg-app-card')}
                        </div>

                        <div class="flex items-center gap-2 mb-2">
                            <h2 class="font-semibold text-lg">Today's Schedule</h2>
                            <span class="bg-app-lighter px-2 py-0.5 rounded text-xs text-app-muted">${todayJobs.length}</span>
                        </div>
                        ${jobsHtml}
                    </div>
                `;
            },

            renderCalendar(container) {
                const today = new Date();
                let selectedDate = this.selectedDate || today.toISOString().split('T')[0];
                const jobsForDate = DB.getJobsForDate(selectedDate);

                // Date Scroller Logic
                let daysHtml = '';
                for(let i=-2; i<12; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() + i);
                    const iso = d.toISOString().split('T')[0];
                    const isSelected = iso === selectedDate;
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                    
                    daysHtml += `
                        <button onclick="router.selectedDate='${iso}'; router.navigate('calendar')" 
                             class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-20 rounded-2xl border ${isSelected ? 'bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-900/50' : 'bg-app-card border-app-border text-app-muted'} transition-all active:scale-95">
                            <span class="text-xs font-medium mb-1 opacity-75">${dayName}</span>
                            <span class="text-xl font-bold">${d.getDate()}</span>
                            ${isSelected ? '<div class="w-1 h-1 rounded-full bg-white mt-1"></div>' : ''}
                        </button>
                    `;
                }

                container.innerHTML = `
                    <div class="pt-12 px-5 pb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">Schedule</h1>
                            <button onclick="router.navigate('today')" class="text-xs font-semibold text-blue-500 bg-blue-500/10 px-3 py-1.5 rounded-lg">Jump to Today</button>
                        </div>
                        
                        <div class="flex gap-3 overflow-x-auto pb-6 no-scrollbar -mx-5 px-5 mb-2">
                            ${daysHtml}
                        </div>

                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <h2 class="font-semibold text-lg text-white">Jobs</h2>
                                <p class="text-app-muted text-sm">${Utils.getFriendlyDate(selectedDate)}</p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            ${jobsForDate.length ? jobsForDate.map(j => this.components.jobCard(j)).join('') : this.components.emptyState('No jobs', 'Tap + to add one')}
                        </div>
                    </div>
                `;
            },

            renderJobDetail(container, { id }) {
                const job = DB.getJob(id);
                if (!job) return router.navigate('today');
                
                const contact = job.contact ? DB.getContactByName(job.contact) : null;
                const statusConfig = DB.statuses[job.status] || DB.statuses['Scheduled'];

                // Status Dropdown Options
                const statusOptions = Object.keys(DB.statuses).map(s => 
                    `<option value="${s}" ${job.status === s ? 'selected' : ''}>${s}</option>`
                ).join('');

                container.innerHTML = `
                    <div class="bg-app-bg min-h-full pb-24">
                        <!-- Header -->
                        <div class="px-5 pt-12 pb-6 bg-gradient-to-b from-app-lighter/50 to-app-bg border-b border-app-border">
                            <button onclick="router.navigate('today')" class="mb-6 text-app-muted hover:text-white flex items-center gap-2">
                                <i class="fa-solid fa-arrow-left"></i> Back
                            </button>
                            
                            <div class="flex justify-between items-start mb-4">
                                <h1 class="text-2xl font-bold leading-tight w-3/4">${job.title}</h1>
                                <button onclick="router.navigate('edit-job-notes', {id: '${job.id}'})" class="w-10 h-10 rounded-full bg-app-card border border-app-border flex items-center justify-center text-app-muted active:bg-blue-600 active:text-white transition-colors">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                            
                            <div class="flex items-center gap-2 mb-4">
                                <div class="px-3 py-1 rounded-lg ${statusConfig.color} bg-opacity-20 text-${statusConfig.color.replace('bg-', '')} border border-${statusConfig.color.replace('bg-', '')} border-opacity-30 text-sm font-semibold flex items-center gap-2">
                                    <i class="fa-solid ${statusConfig.icon}"></i>
                                    ${job.status}
                                </div>
                                <span class="text-app-muted text-sm">â€¢ ${job.service}</span>
                            </div>

                            <!-- Workflow / Status Changer -->
                            <div class="relative">
                                <select onchange="DB.updateJob('${job.id}', {status: this.value}); router.navigate('job-detail', {id: '${job.id}'})" 
                                    class="w-full bg-app-card border border-app-border text-white py-3 px-4 rounded-xl appearance-none focus:border-blue-500 outline-none">
                                    ${statusOptions}
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-app-muted pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="px-5 mt-6 space-y-6">
                            <!-- Time & Location -->
                            <div class="bg-app-card border border-app-border rounded-xl p-4">
                                <h3 class="text-xs font-semibold text-app-muted uppercase mb-3">Time & Location</h3>
                                <div class="flex items-start gap-4 mb-4">
                                    <div class="w-10 h-10 rounded-lg bg-blue-500/10 text-blue-500 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-regular fa-clock"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-white">${Utils.getFriendlyDate(job.date)}</p>
                                        <p class="text-app-muted">${job.time}</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="w-10 h-10 rounded-lg bg-orange-500/10 text-orange-500 flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-location-dot"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-white leading-tight mb-1">${job.address || 'No address'}</p>
                                        <a href="https://maps.google.com/?q=${encodeURIComponent(job.address)}" target="_blank" 
                                           class="text-blue-500 text-sm font-medium hover:underline flex items-center gap-1">
                                           Get Directions <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes Section (Enhanced) -->
                            <div class="bg-app-card border border-app-border rounded-xl p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-xs font-semibold text-app-muted uppercase">Notes & Timeline</h3>
                                    <button onclick="router.navigate('edit-job-notes', {id: '${job.id}'})" class="text-xs text-blue-500 font-medium">Edit Notes</button>
                                </div>
                                <div class="bg-app-bg rounded-lg p-3 text-sm text-gray-300 min-h-[80px] leading-relaxed whitespace-pre-wrap">
                                    ${job.notes ? job.notes : '<span class="text-app-muted italic">No notes added for this job yet. Tap Edit Notes to add details.</span>'}
                                </div>
                            </div>

                            <!-- Client Actions -->
                            <div class="bg-app-card border border-app-border rounded-xl p-4">
                                <h3 class="text-xs font-semibold text-app-muted uppercase mb-3">Client Details</h3>
                                ${contact ? `
                                    <div class="flex items-center gap-3 mb-4">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg">
                                            ${contact.name.charAt(0)}
                                        </div>
                                        <div>
                                            <p class="font-bold text-lg">${contact.name}</p>
                                            <p class="text-sm text-app-muted">${contact.company || 'Private Client'}</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <a href="tel:${contact.phone}" class="bg-app-lighter hover:bg-green-600/20 hover:text-green-500 hover:border-green-500/50 border border-app-border rounded-xl py-3 flex flex-col items-center justify-center transition-all group">
                                            <i class="fa-solid fa-phone mb-1 text-xl group-hover:scale-110 transition-transform"></i>
                                            <span class="text-xs font-medium">Call</span>
                                        </a>
                                        <a href="sms:${contact.phone}" class="bg-app-lighter hover:bg-blue-600/20 hover:text-blue-500 hover:border-blue-500/50 border border-app-border rounded-xl py-3 flex flex-col items-center justify-center transition-all group">
                                            <i class="fa-solid fa-message mb-1 text-xl group-hover:scale-110 transition-transform"></i>
                                            <span class="text-xs font-medium">Message</span>
                                        </a>
                                    </div>
                                ` : `
                                    <div class="text-center py-4 text-app-muted">
                                        <p class="mb-2">No contact linked</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            },

            // New View for Editing Notes
            renderEditJobNotes(container, { id }) {
                const job = DB.getJob(id);
                if(!job) return router.navigate('today');

                container.innerHTML = `
                     <div class="pt-12 px-5 pb-24 h-full flex flex-col">
                        <div class="flex items-center gap-4 mb-6">
                            <button onclick="router.navigate('job-detail', {id: '${id}'})" class="text-app-muted hover:text-white"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                            <h1 class="text-xl font-bold">Edit Job Notes</h1>
                        </div>

                        <form onsubmit="handleUpdateNotes(event, '${id}')" class="flex-1 flex flex-col">
                             <div class="flex-1 mb-4">
                                <textarea name="notes" class="w-full h-full bg-app-card border border-app-border rounded-xl p-4 text-white placeholder-app-muted focus:outline-none focus:border-blue-500 resize-none text-base leading-relaxed" placeholder="Type notes here...">${job.notes || ''}</textarea>
                             </div>
                             <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition-colors">
                                Save Notes
                            </button>
                        </form>
                    </div>
                `;
            },

            renderContacts(container) {
                const contacts = DB.contacts;
                const content = contacts.length === 0 ? this.components.emptyState('No contacts yet', 'Add or import your clients') : 
                `<div class="space-y-3 pb-20 px-5">${contacts.map(c => `
                    <div class="bg-app-card p-4 rounded-xl border border-app-border flex items-center gap-4 active:border-blue-500/50 transition-colors">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-md shrink-0">
                            ${c.name.substring(0,2).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-white truncate">${c.name}</h3>
                            <p class="text-xs text-app-muted truncate">${c.company || 'Private Customer'}</p>
                            ${c.address ? `<p class="text-[10px] text-app-muted mt-0.5 truncate"><i class="fa-solid fa-location-dot mr-1"></i>${c.address}</p>` : ''}
                        </div>
                        <div class="flex gap-2">
                             <a href="sms:${c.phone}" class="w-9 h-9 rounded-full bg-app-lighter text-app-muted flex items-center justify-center hover:bg-blue-600 hover:text-white transition-colors border border-app-border">
                                <i class="fa-solid fa-message text-sm"></i>
                            </a>
                            <a href="tel:${c.phone}" class="w-9 h-9 rounded-full bg-app-lighter text-app-muted flex items-center justify-center hover:bg-green-600 hover:text-white transition-colors border border-app-border">
                                <i class="fa-solid fa-phone text-sm"></i>
                            </a>
                        </div>
                    </div>
                `).join('')}</div>`;

                container.innerHTML = `
                    <div class="pt-12">
                        <div class="px-5 mb-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold">Contacts</h1>
                            <button onclick="router.navigate('new-contact')" class="w-9 h-9 rounded-full bg-blue-500 text-white shadow-lg shadow-blue-500/30 flex items-center justify-center">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        
                        <!-- Search Bar -->
                        <div class="px-5 mb-6">
                            <div class="relative group">
                                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-app-muted group-focus-within:text-blue-500 transition-colors"></i>
                                <input type="text" placeholder="Search name or company..." class="w-full bg-app-card border border-app-border rounded-xl py-3 pl-11 pr-4 text-white placeholder-app-muted focus:outline-none focus:border-blue-500 transition-all">
                            </div>
                        </div>

                        ${content}
                    </div>
                `;
            },

            renderNewJob(container) {
                container.innerHTML = `
                    <div class="pt-12 px-5 pb-24 min-h-full">
                        <div class="flex items-center gap-4 mb-6">
                            <button onclick="router.navigate('today')" class="text-app-muted hover:text-white w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                            <h1 class="text-xl font-bold">New Job</h1>
                        </div>

                        <form onsubmit="handleNewJob(event)" class="space-y-5 animate-[slideUp_0.3s_ease-out]">
                            <div>
                                <label class="block text-xs font-semibold text-app-muted mb-1.5 uppercase ml-1">Job Details</label>
                                <input type="text" name="title" required placeholder="Job Title (e.g. Kitchen Wrap)" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white placeholder-app-muted focus:outline-none focus:border-blue-500 mb-3">
                                
                                <div class="relative">
                                    <select name="service" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white appearance-none focus:outline-none focus:border-blue-500">
                                        <option>Kitchen Wrap</option>
                                        <option>Window Film</option>
                                        <option>Commercial Signage</option>
                                        <option>Vehicle Wrap</option>
                                        <option>Maintenance</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-app-muted pointer-events-none text-xs"></i>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-app-muted mb-1.5 uppercase ml-1">Date</label>
                                    <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white focus:outline-none focus:border-blue-500 [color-scheme:dark]">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-app-muted mb-1.5 uppercase ml-1">Time</label>
                                    <input type="time" name="time" value="09:00" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white focus:outline-none focus:border-blue-500 [color-scheme:dark]">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-app-muted mb-1.5 uppercase ml-1">Client & Location</label>
                                <div class="relative mb-3">
                                    <select name="contact" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white appearance-none focus:outline-none focus:border-blue-500">
                                        <option value="">Select Existing Contact...</option>
                                        ${DB.contacts.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                                    </select>
                                    <i class="fa-solid fa-user absolute right-4 top-4 text-app-muted pointer-events-none text-xs"></i>
                                </div>
                                <div class="relative">
                                    <input type="text" name="address" placeholder="Site Address" class="w-full bg-app-card border border-app-border rounded-xl p-3 pl-10 text-white placeholder-app-muted focus:outline-none focus:border-blue-500">
                                    <i class="fa-solid fa-location-dot absolute left-3.5 top-3.5 text-app-muted"></i>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-app-muted mb-1.5 uppercase ml-1">Assignment</label>
                                <div class="relative">
                                    <select name="assigned" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white appearance-none focus:outline-none focus:border-blue-500">
                                        <option>Richard (Me)</option>
                                        <option>Team Install A</option>
                                        <option>Subcontractor</option>
                                    </select>
                                    <i class="fa-solid fa-helmet-safety absolute right-4 top-4 text-app-muted pointer-events-none text-xs"></i>
                                </div>
                            </div>

                             <div>
                                <label class="block text-xs font-semibold text-app-muted mb-1.5 uppercase ml-1">Notes</label>
                                <textarea name="notes" rows="3" placeholder="Job details, gate codes, etc." class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white placeholder-app-muted focus:outline-none focus:border-blue-500"></textarea>
                            </div>

                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-900/40 transition-colors mt-4">
                                Save Job
                            </button>
                        </form>
                    </div>
                `;
            },

            renderNewContact(container) {
                container.innerHTML = `
                    <div class="pt-12 px-5 pb-24 h-full overflow-y-auto">
                        <div class="flex items-center gap-4 mb-6">
                            <button onclick="router.navigate('contacts')" class="text-app-muted hover:text-white"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                            <h1 class="text-xl font-bold">New Contact</h1>
                        </div>

                        <form onsubmit="handleNewContact(event)" class="space-y-5">
                            <div class="grid grid-cols-[auto_1fr] gap-4 items-center mb-6">
                                <div class="w-16 h-16 rounded-full bg-app-lighter border-2 border-dashed border-app-muted flex items-center justify-center text-app-muted">
                                    <i class="fa-solid fa-camera text-xl"></i>
                                </div>
                                <input type="text" name="name" required placeholder="Full Name *" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white focus:outline-none focus:border-blue-500">
                            </div>
                            
                            <input type="text" name="company" placeholder="Company Name" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white focus:outline-none focus:border-blue-500">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <input type="tel" name="phone" placeholder="Mobile Phone" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white focus:outline-none focus:border-blue-500">
                                <input type="email" name="email" placeholder="Email Address" class="w-full bg-app-card border border-app-border rounded-xl p-3 text-white focus:outline-none focus:border-blue-500">
                            </div>

                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-900/40 transition-colors mt-8">
                                Save Contact
                            </button>
                        </form>
                    </div>
                `;
            },

            renderMore(container) {
                container.innerHTML = `
                    <div class="pt-12 px-5 pb-20">
                        <h1 class="text-2xl font-bold mb-6">Menu</h1>
                        
                        <div class="bg-app-card border border-app-border rounded-xl overflow-hidden mb-6">
                            <div class="p-4 flex items-center gap-3 border-b border-app-border">
                                <div class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center"><i class="fa-solid fa-user text-xl"></i></div>
                                <div>
                                    <p class="font-bold text-white">${DB.user.name}</p>
                                    <p class="text-xs text-app-muted">${DB.user.email}</p>
                                </div>
                            </div>
                            <button class="w-full text-left p-4 hover:bg-app-lighter transition text-sm flex justify-between">Account Settings <i class="fa-solid fa-chevron-right text-xs text-app-muted"></i></button>
                        </div>

                        <div class="space-y-2">
                             <button onclick="document.getElementById('csvInput').click()" class="w-full bg-app-card p-4 rounded-xl border border-app-border flex items-center justify-between text-white active:bg-app-lighter">
                                <span class="flex items-center gap-3"><i class="fa-solid fa-file-csv text-green-500 w-5"></i> Import Contacts (CSV)</span>
                                <i class="fa-solid fa-chevron-right text-xs text-app-muted"></i>
                            </button>
                             <button class="w-full bg-app-card p-4 rounded-xl border border-app-border flex items-center justify-between text-white">
                                <span class="flex items-center gap-3"><i class="fa-solid fa-file-invoice text-app-muted w-5"></i> Invoices</span>
                            </button>
                             <button class="w-full bg-app-card p-4 rounded-xl border border-app-border flex items-center justify-between text-white">
                                <span class="flex items-center gap-3"><i class="fa-solid fa-gear text-app-muted w-5"></i> App Settings</span>
                            </button>
                            <button onclick="localStorage.clear(); location.reload()" class="w-full bg-app-card p-4 rounded-xl border border-red-900/30 flex items-center justify-between text-red-400">
                                <span class="flex items-center gap-3"><i class="fa-solid fa-right-from-bracket w-5"></i> Reset Demo Data</span>
                            </button>
                        </div>
                    </div>
                `;
            },

            // --- REUSABLE COMPONENTS ---
            components: {
                statCard(label, count, textColor, bgClass) {
                    return `
                    <div class="bg-app-card p-3 rounded-xl border border-app-border flex flex-col items-center justify-center py-4">
                        <span class="text-2xl font-bold ${textColor}">${count}</span>
                        <span class="text-[10px] text-app-muted uppercase tracking-wider mt-1">${label}</span>
                    </div>`;
                },
                emptyState(title, sub) {
                    return `
                    <div class="mt-8 border-2 border-dashed border-app-lighter rounded-xl p-10 flex flex-col items-center justify-center text-center">
                        <i class="fa-solid fa-clipboard-check text-4xl text-app-lighter mb-4"></i>
                        <p class="text-white font-medium mb-1">${title}</p>
                        <p class="text-app-muted text-sm">${sub}</p>
                    </div>`;
                },
                jobCard(job) {
                    const statusColor = DB.statuses[job.status] ? DB.statuses[job.status].color.replace('bg-', 'text-') : 'text-blue-500';
                    return `
                        <div onclick="router.navigate('job-detail', {id: '${job.id}'})" class="bg-app-card border border-app-border rounded-xl p-4 flex gap-4 active:scale-[0.98] transition-transform cursor-pointer">
                            <div class="flex-shrink-0 flex flex-col items-center pt-1">
                                <span class="text-xs text-app-muted font-bold">${job.time}</span>
                                <div class="w-0.5 h-full bg-app-border mt-2 rounded-full"></div>
                            </div>
                            <div class="flex-1 pb-1">
                                <div class="flex justify-between items-start mb-1">
                                    <h3 class="font-semibold text-white text-lg leading-tight">${job.title}</h3>
                                    ${job.status === 'Completed' ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : ''}
                                </div>
                                <p class="text-sm font-medium ${statusColor} mb-2 flex items-center gap-1.5">
                                    <span class="w-1.5 h-1.5 rounded-full ${DB.statuses[job.status]?.color || 'bg-gray-500'}"></span>
                                    ${job.status}
                                </p>
                                
                                <div class="flex items-start gap-2 text-app-muted text-xs mb-3">
                                    <i class="fa-solid fa-location-dot mt-0.5"></i>
                                    <span class="line-clamp-1">${job.address || 'No address provided'}</span>
                                </div>
                                
                                <div class="flex items-center justify-between border-t border-app-border pt-3 mt-2">
                                    <span class="px-2 py-1 rounded-md bg-app-lighter text-[10px] text-slate-300 font-medium tracking-wide">
                                        ${job.service}
                                    </span>
                                    ${job.contact ? `<span class="flex items-center gap-1.5 text-xs text-indigo-400 font-medium"><i class="fa-solid fa-user"></i> ${job.contact}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // --- HANDLERS ---
        function toggleFabMenu() {
            const menu = document.getElementById('fab-menu');
            const overlay = document.getElementById('fab-overlay');
            const icon = document.getElementById('fab-icon');
            
            const isHidden = menu.classList.contains('hidden');
            
            if (isHidden) {
                menu.classList.remove('hidden');
                menu.classList.add('flex');
                overlay.classList.remove('hidden');
                icon.classList.remove('fa-plus');
                icon.classList.add('fa-xmark');
                icon.classList.add('rotate-90');
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('flex');
                overlay.classList.add('hidden');
                icon.classList.add('fa-plus');
                icon.classList.remove('fa-xmark');
                icon.classList.remove('rotate-90');
            }
        }

        function handleNewJob(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            DB.addJob({
                title: formData.get('title'),
                service: formData.get('service'),
                date: formData.get('date'),
                time: formData.get('time'),
                address: formData.get('address'),
                assigned: formData.get('assigned'),
                contact: formData.get('contact'),
                status: 'Scheduled',
                notes: formData.get('notes') || ''
            });
            router.navigate('today');
        }

        function handleUpdateNotes(e, id) {
            e.preventDefault();
            const formData = new FormData(e.target);
            DB.updateJob(id, { notes: formData.get('notes') });
            router.navigate('job-detail', {id});
            Utils.toast('Notes updated');
        }

        function handleNewContact(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            DB.addContact({
                name: formData.get('name'),
                company: formData.get('company'),
                phone: formData.get('phone'),
                email: formData.get('email')
            });
            router.navigate('contacts');
        }

        // CSV UPLOAD HANDLER
        function handleCSVUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                // Assuming standard headers based on user file:
                // Name, First Name, Last Name, Company Name, Job Title, Dept, Email, Phone, Street, State, City, PostCode, Country...
                
                let successCount = 0;
                
                // Skip header (i=1)
                for(let i=1; i<lines.length; i++) {
                    const line = lines[i].trim();
                    if(!line) continue;

                    // Parse line respecting quotes
                    const cols = parseCSVRow(line);
                    
                    if (cols && cols[0]) {
                        // Map CSV columns to App Data
                        const contact = {
                            name: cols[0], // Full Name
                            company: cols[3], // Company Name
                            email: cols[6], // Email
                            phone: cols[7], // Phone
                            address: `${cols[8] || ''}, ${cols[10] || ''} ${cols[11] || ''}`.replace(/^, /, '').trim() // Street, City Zip
                        };
                        
                        // Clean up address if empty commas remain
                        if(contact.address === ', ') contact.address = '';

                        if (DB.addContact(contact)) {
                            successCount++;
                        }
                    }
                }
                
                Utils.toast(`Imported ${successCount} contacts successfully`);
                router.navigate('contacts');
                input.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        // Helper for CSV parsing logic
        function parseCSVRow(str) {
            const result = [];
            let cell = '';
            let inQuote = false;
            
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                if (char === '"') {
                    inQuote = !inQuote;
                } else if (char === ',' && !inQuote) {
                    result.push(cell);
                    cell = '';
                } else {
                    cell += char;
                }
            }
            result.push(cell);
            // Clean up quotes around cells if present
            return result.map(c => c.replace(/^"|"$/g, '').trim());
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            DB.init();
            
            // Seed dummy data if empty for better first impression
            if(DB.jobs.length === 0) {
                DB.addJob({id: '1', title: 'Window Tinting - Front', service: 'Window Film', date: new Date().toISOString().split('T')[0], time: '10:00', address: '123 Maple Ave, Springfield', status: 'In Progress', contact: 'John Doe', notes: 'Gate code is 1234'});
                DB.addContact({id: '1', name: 'John Doe', company: 'JD Logistics', phone: '555-0123'});
            }
            
            router.navigate('today');
        });
    </script>
</body>
</html>
